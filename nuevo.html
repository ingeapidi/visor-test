<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Proyecto - Geoportal Cloud</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            overflow-y: auto !important; 
            height: auto !important;
        }
        .form-container {
            padding-bottom: 100px;
        }
    </style>
</head>
<body>
    <header>
        <a href="inicio.html" class="logo"><i class="fas fa-satellite-dish"></i> GEOPORTAL CLOUD</a>
        <a href="admin.html" class="user-access" style="color:white; text-decoration:none;"><i class="fas fa-tachometer-alt"></i> Panel</a>
    </header>

    <div class="form-container">
        <a href="admin.html" style="display:inline-block; margin-bottom:20px; color:var(--accent); font-weight:bold;">← Volver al Dashboard</a>
        
        <div class="card">
            <h2>Configurar Nuevo Proyecto</h2>
            <p style="color:var(--text-slate); margin-bottom:30px;">Defina el espacio de trabajo y cargue los insumos técnicos.</p>
            
            <label>Espacio de Trabajo</label>
            <select id="selectEspacio" onchange="verificarNuevoEspacio()">
                <option value="">-- Seleccionar Espacio --</option>
                <option value="NUEVO">+ Crear Nuevo Espacio</option>
            </select>

            <div id="sectionNuevoEspacio" style="display:none; margin-top: 10px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--accent);">
                <label>Nombre del Nuevo Espacio</label>
                <input type="text" id="nombreNuevoEspacio" placeholder="Ej: MINA SANTA RITA">
            </div>

            <div style="margin-top: 20px;">
                <label>Nombre del Proyecto</label>
                <input type="text" id="proyNombre" placeholder="Ej: Relevamiento Lidar - Dique 4">

                <label>Cliente / Mandante</label>
                <input type="text" id="proyCliente" placeholder="Ej: Minera Alumbrera S.A.">

                <label>Ubicación Referencial</label>
                <input type="text" id="proyUbicacion" placeholder="Ej: Catamarca, Argentina">
            </div>

            <label>Archivos del Relevamiento (Simulación)</label>
            <div class="upload-zone">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                <p>Los archivos se asociarán al proyecto una vez creado</p>
            </div>

            <button id="btnCrear" class="btn btn-primary" style="width:100%; margin-top:30px; justify-content:center;">
                CREAR PROYECTO Y FINALIZAR
            </button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Carga los espacios filtrados por el usuario logueado
        async function cargarEspacios() {
            const usuario = verificarSesion();
            if(!usuario) return;

            try {
                const res = await fetch(`${API_URL}?action=obtener_datos_admin&id_usuario=${usuario.id}`);
                const result = await res.json();

                if (result.success) {
                    const select = document.getElementById('selectEspacio');
                    while (select.options.length > 2) { select.remove(2); }
                    
                    result.data.espacios.forEach(esp => {
                        const opt = document.createElement('option');
                        opt.value = esp[0]; // ID del espacio
                        opt.innerText = esp[2]; // Nombre del espacio
                        select.add(opt, select.options[1]);
                    });
                }
            } catch (e) { console.error("Error cargando espacios", e); }
        }

        function verificarNuevoEspacio() {
            const select = document.getElementById('selectEspacio');
            const section = document.getElementById('sectionNuevoEspacio');
            section.style.display = (select.value === "NUEVO") ? "block" : "none";
        }

        async function ejecutarCreacion() {
            const usuario = verificarSesion();
            const btn = document.getElementById('btnCrear');
            const select = document.getElementById('selectEspacio');
            
            let idEspacioFinal = select.value;
            const proyNombre = document.getElementById('proyNombre').value;

            // Validación de campos obligatorios antes de disparar la API
            if (!idEspacioFinal || !proyNombre) {
                alert("Condición Restrictiva: Debe seleccionar un Espacio y asignar un Nombre al Proyecto.");
                return;
            }

            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            try {
                // PASO 1: Creación simultánea de Espacio si es requerido
                if (idEspacioFinal === "NUEVO") {
                    const nombreE = document.getElementById('nombreNuevoEspacio').value;
                    if(!nombreE) throw new Error("Debe asignar un nombre al nuevo espacio de trabajo.");
                    
                    const resE = await callApi('crear_espacio', {
                        id_usuario: usuario.id,
                        nombre: nombreE,
                        descripcion: "Espacio automático",
                        email: usuario.email
                    });
                    
                    if (resE && resE.success) {
                        idEspacioFinal = resE.data.id_creado; // Vinculamos el ID recién nacido
                    } else {
                        // Aquí capturamos errores como "Nombre ya existe" del servidor
                        throw new Error(resE.message || "Error al crear espacio.");
                    }
                }

                // PASO 2: Creación del Proyecto (Garantiza vínculo obligatorio)
                const resP = await callApi('crear_proyecto', {
                    id_espacio: idEspacioFinal,
                    nombre: proyNombre,
                    cliente: document.getElementById('proyCliente').value,
                    contratista: usuario.empresa,
                    ubicacion: document.getElementById('proyUbicacion').value
                });

                if (resP && resP.success) {
                    alert("¡Éxito! El proyecto ha sido vinculado correctamente al espacio.");
                    window.location.href = 'admin.html';
                } else {
                    throw new Error(resP.message || "Error al crear el proyecto.");
                }

            } catch (error) {
                alert("Aviso: " + error.message);
                // Si el espacio se creó pero falló el proyecto, refrescamos la lista
                await cargarEspacios(); 
            } finally {
                btn.disabled = false;
                btn.innerText = "CREAR PROYECTO Y FINALIZAR";
            }
        }

        window.onload = () => {
            if (typeof inicializarInterfaz === 'function') inicializarInterfaz();
            cargarEspacios();
            document.getElementById('btnCrear').onclick = ejecutarCreacion;
        };
    </script>
</body>
</html>
