<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Proyecto - Geoportal Cloud</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            overflow-y: auto !important; 
            height: auto !important;
        }
        .form-container {
            padding-bottom: 100px;
        }
    </style>
</head>
<body>
    <header>
        <a href="inicio.html" class="logo"><i class="fas fa-satellite-dish"></i> GEOPORTAL CLOUD</a>
        <a href="admin.html" class="user-access" style="color:white; text-decoration:none;"><i class="fas fa-tachometer-alt"></i> Panel</a>
    </header>

    <div class="form-container">
        <a href="admin.html" style="display:inline-block; margin-bottom:20px; color:var(--accent); font-weight:bold;">← Volver al Dashboard</a>
        
        <div class="card">
            <h2>Configurar Nuevo Proyecto</h2>
            <p style="color:var(--text-slate); margin-bottom:30px;">Defina el espacio de trabajo y cargue los insumos técnicos.</p>
            
            <label>Espacio de Trabajo</label>
            <select id="selectEspacio" onchange="verificarNuevoEspacio()">
                <option value="">-- Seleccionar Espacio --</option>
                <option value="NUEVO">+ Crear Nuevo Espacio</option>
            </select>

            <div id="sectionNuevoEspacio" style="display:none; margin-top: 10px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--accent);">
                <label>Nombre del Nuevo Espacio</label>
                <input type="text" id="nombreNuevoEspacio" placeholder="Ej: MINA SANTA RITA">
            </div>

            <div style="margin-top: 20px;">
                <label>Nombre del Proyecto</label>
                <input type="text" id="proyNombre" placeholder="Ej: Relevamiento Lidar - Dique 4">

                <label>Cliente / Mandante</label>
                <input type="text" id="proyCliente" placeholder="Ej: Minera Alumbrera S.A.">

                <label>Ubicación Referencial</label>
                <input type="text" id="proyUbicacion" placeholder="Ej: Catamarca, Argentina">
            </div>

            <label>Archivos del Relevamiento (Simulación)</label>
            <div class="upload-zone">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                <p>Los archivos se asociarán al proyecto una vez creado</p>
            </div>

            <button id="btnCrear" class="btn btn-primary" style="width:100%; margin-top:30px; justify-content:center;">
                CREAR PROYECTO Y FINALIZAR
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/api.js"></script>

    <script>
        // 1. Cargar espacios desde la tabla 'espacios' de Supabase
        async function cargarEspacios() {
            const usuario = verificarSesion();
            if(!usuario) return;

            try {
                const { data, error } = await supabase
                    .from('espacios')
                    .select('id, nombre')
                    .order('nombre', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('selectEspacio');
                // Limpiar opciones manteniendo las dos primeras
                while (select.options.length > 2) { select.remove(2); }
                
                data.forEach(esp => {
                    const opt = document.createElement('option');
                    opt.value = esp.id; 
                    opt.innerText = esp.nombre; 
                    select.add(opt, select.options[1]);
                });
            } catch (e) { 
                console.error("Error cargando espacios", e); 
            }
        }

        function verificarNuevoEspacio() {
            const select = document.getElementById('selectEspacio');
            const section = document.getElementById('sectionNuevoEspacio');
            section.style.display = (select.value === "NUEVO") ? "block" : "none";
        }

        async function ejecutarCreacion() {
            const usuario = verificarSesion();
            const btn = document.getElementById('btnCrear');
            const select = document.getElementById('selectEspacio');
            
            let idEspacioFinal = select.value;
            const proyNombre = document.getElementById('proyNombre').value;

            if (!idEspacioFinal || !proyNombre) {
                alert("Debe seleccionar un Espacio y asignar un Nombre al Proyecto.");
                return;
            }

            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            try {
                // PASO 1: Crear Espacio en Supabase si es requerido
                if (idEspacioFinal === "NUEVO") {
                    const nombreE = document.getElementById('nombreNuevoEspacio').value;
                    if(!nombreE) throw new Error("Debe asignar un nombre al nuevo espacio.");
                    
                    const { data: nuevoEspacio, error: errorE } = await supabase
                        .from('espacios')
                        .insert([{ 
                            nombre: nombreE, 
                            propietario_id: usuario.id,
                            descripcion: "Espacio creado desde formulario"
                        }])
                        .select()
                        .single();

                    if (errorE) {
                        if (errorE.code === '23505') throw new Error("Ya tienes un espacio con ese nombre.");
                        throw errorE;
                    }
                    
                    idEspacioFinal = nuevoEspacio.id;
                }

                // PASO 2: Crear el Proyecto vinculado en Supabase
                const { data: nuevoProy, error: errorP } = await supabase
                    .from('proyectos')
                    .insert([{
                        espacio_id: idEspacioFinal,
                        nombre: proyNombre,
                        cliente: document.getElementById('proyCliente').value,
                        contratista: usuario.empresa,
                        ubicacion: document.getElementById('proyUbicacion').value
                    }])
                    .select()
                    .single();

                if (errorP) {
                    if (errorP.code === '23505') throw new Error("Ya existe un proyecto con ese nombre en este espacio.");
                    throw errorP;
                }

                alert("¡Proyecto creado con éxito!");
                window.location.href = 'admin.html';

            } catch (error) {
                alert("Error: " + error.message);
                console.error(error);
                await cargarEspacios(); 
            } finally {
                btn.disabled = false;
                btn.innerText = "CREAR PROYECTO Y FINALIZAR";
            }
        }

        window.onload = () => {
            cargarEspacios();
            document.getElementById('btnCrear').onclick = ejecutarCreacion;
        };
    </script>
</body>
</html>
