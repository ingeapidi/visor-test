<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visor WebGIS - Geoportal Cloud</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
</head>
<body>
<header>
    <div class="logo" onclick="location.href='inicio.html'"><i class="fas fa-satellite-dish"></i> GEOPORTAL CLOUD</div>
    <div class="project-title" id="txt-proyecto-header">CARGANDO PROYECTO...</div>
    <div class="user-access" onclick="location.href='perfil.html'"><i class="fas fa-user-circle" style="font-size: 1.5rem;"></i></div>
</header>
<main>
    <aside class="sidebar">
        <div class="tree-title">Información</div>
        <div id="proyecto-info" style="padding: 10px 20px; font-size: 0.85rem; color: #cbd5e1;">
            </div>
    </aside>
    
    <div style="flex-grow: 1; position: relative;">
        <div id="map"></div>
    </div>

    <aside class="sidebar sidebar-right">
        <div class="section-h">Capas Disponibles <i class="fas fa-layer-group"></i></div>
        <div id="lista-capas">
            <p style="padding: 20px; font-size: 0.8rem; opacity: 0.6;">Buscando capas...</p>
        </div>
        
        <div class="section-h">Operaciones <i class="fas fa-tools"></i></div>
        <div class="tool-grid" style="padding: 0 20px;">
            <div class="layer-card" style="text-align:center"><i class="fas fa-ruler"></i><br>Medir</div>
            <div class="layer-card" style="text-align:center"><i class="fas fa-cube"></i><br>Volumen</div>
        </div>
    </aside>
</main>
<footer>
    <div><span class="status-highlight">GEO:</span> <span id="mouse-coords">- / -</span></div>
    <div><span class="status-highlight">PROYECTO ID:</span> <span id="txt-proyecto-id">---</span></div>
    <div style="margin-left: auto;" id="txt-ubicacion">SISTEMA: WGS84 / EPSG:3857</div>
</footer>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/api.js"></script>

<script>
    let map;
    
    async function inicializarVisor() {
        // 1. Verificar sesión y obtener ID del proyecto desde URL
        const usuario = verificarSesion();
        if (!usuario) return;

        const urlParams = new URLSearchParams(window.location.search);
        const proyectoId = urlParams.get('id');

        if (!proyectoId) {
            alert("No se especificó un ID de proyecto.");
            window.location.href = 'admin.html';
            return;
        }

        // 2. Cargar datos del proyecto y sus archivos desde Supabase
        try {
            // Consulta combinada: Proyecto + sus Archivos
            const { data: proyecto, error: errP } = await supabase
                .from('proyectos')
                .select(`
                    *,
                    archivos (*)
                `)
                .eq('id', proyectoId)
                .single();

            if (errP) throw errP;

            // 3. Actualizar Interfaz
            document.getElementById('txt-proyecto-header').innerText = `PROYECTO: ${proyecto.nombre}`;
            document.getElementById('txt-proyecto-id').innerText = proyecto.id.substring(0,8);
            document.getElementById('txt-ubicacion').innerText = `UBICACIÓN: ${proyecto.ubicacion || 'No definida'}`;
            
            document.getElementById('proyecto-info').innerHTML = `
                <div class="tree-item active"><i class="fas fa-map"></i> ${proyecto.nombre}</div>
                <p style="margin-top:10px; opacity:0.8"><b>Cliente:</b><br>${proyecto.cliente}</p>
            `;

            renderizarCapas(proyecto.archivos);
            iniciarMapa();

        } catch (error) {
            console.error("Error cargando el visor:", error);
            alert("No tienes permisos para ver este proyecto o no existe.");
            window.location.href = 'admin.html';
        }
    }

    function renderizarCapas(archivos) {
        const container = document.getElementById('lista-capas');
        if (!archivos || archivos.length === 0) {
            container.innerHTML = '<p style="padding:20px; font-size:0.8rem; opacity:0.5;">Este proyecto no tiene archivos vinculados aún.</p>';
            return;
        }

        container.innerHTML = archivos.map(archivo => `
            <div class="layer-card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <i class="fas fa-file-alt" style="margin-right:8px; opacity:0.6"></i>
                    <span>${archivo.nombre_real}</span>
                </div>
                <i class="fas fa-eye" style="color:var(--accent); cursor:pointer;" onclick="toggleCapa('${archivo.drive_id}')"></i>
            </div>
        `).join('');
    }

    function iniciarMapa() {
        map = new maplibregl.Map({
            container: 'map',
            style: { 
                version: 8, 
                sources: { 
                    'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } 
                }, 
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }] 
            },
            center: [-60.712, -31.648], 
            zoom: 14
        });

        map.on('mousemove', (e) => {
            document.getElementById('mouse-coords').innerText = `${e.lngLat.lng.toFixed(4)} / ${e.lngLat.lat.toFixed(4)}`;
        });
    }

    function toggleCapa(driveId) {
        console.log("Capa solicitada de Google Drive ID:", driveId);
        alert("En la siguiente etapa conectaremos el ID de Drive " + driveId + " con el servidor de teselas (Cloud Optimized GeoTIFF).");
    }

    window.onload = inicializarVisor;
</script>
</body>
</html>
