<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administración - Geoportal Cloud</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tree-item { cursor: pointer; transition: all 0.2s; border-right: 3px solid transparent; }
        .tree-item:hover { background-color: rgba(0,0,0,0.05); }
        .tree-item.active {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border-right: 3px solid #2563eb;
            font-weight: bold;
        }
    </style>
</head>
<body>
<header>
    <div class="logo" onclick="location.href='inicio.html'"><i class="fas fa-satellite-dish"></i> GEOPORTAL CLOUD</div>
    <div class="header-title">PANEL DE CONTROL GENERAL</div>
    <div class="user-access" onclick="location.href='perfil.html'">
        <div style="text-align: right;"><small id="headerUserName">Cargando...</small><br><b style="font-size: 0.7em; opacity: 0.6;">ADMINISTRADOR</b></div>
        <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
    </div>
</header>
<main>
    <aside class="sidebar">
        <div style="padding: 20px;">
            <button class="btn btn-primary" style="width:100%" onclick="location.href='nuevo.html'">
                <i class="fas fa-plus"></i> CREAR NUEVO
            </button>
        </div>
        <div class="tree-title">Espacios de Trabajo</div>
        <div id="lista-espacios">
            <p style="padding: 10px 20px; font-size: 0.8rem; opacity: 0.5;">Cargando espacios...</p>
        </div>
    </aside>

    <div class="container-scroll">
        <div class="stats-grid">
            <div class="card"><small>ALMACENAMIENTO</small><div id="stat-storage" style="font-size: 1.6rem; font-weight: 800; margin: 8px 0;">-- TB</div></div>
            <div class="card"><small>PROYECTOS MOSTRADOS</small><div id="stat-projects" style="font-size: 1.6rem; font-weight: 800; margin: 8px 0;">0</div></div>
            <div class="card"><small>INGESTAS MES</small><div style="font-size: 1.6rem; font-weight: 800; margin: 8px 0;">--</div></div>
            <div class="card" style="border-right: 4px solid var(--error);"><small>ALERTAS</small><div style="font-size: 1.6rem; font-weight: 800; margin: 8px 0; color: var(--error);">0</div></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                <div>
                    <h2 id="titulo-seccion" style="margin:0;">Todos los Proyectos</h2>
                    <p id="subtitulo-seccion" style="color:var(--text-slate)">Listado general de relevamientos cargados</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Cliente</th>
                        <th>Ubicación</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="tabla-proyectos">
                    <tr><td colspan="5" style="text-align:center;">Buscando proyectos en Supabase...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/api.js"></script>

<script>
    let proyectosGlobales = [];

    async function cargarDashboard() {
        const usuario = verificarSesion();
        if (!usuario) return;

        // Mostrar nombre en el header
        document.getElementById('headerUserName').innerText = usuario.email.split('@')[0].toUpperCase();

        try {
            // 1. Obtener Espacios (Filtrados por RLS automáticamente)
            const { data: espacios, error: errE } = await supabase
                .from('espacios')
                .select('*')
                .order('nombre', { ascending: true });

            if (errE) throw errE;

            // 2. Obtener Proyectos (Filtrados por RLS automáticamente)
            const { data: proyectos, error: errP } = await supabase
                .from('proyectos')
                .select('*')
                .order('fecha_creacion', { ascending: false });

            if (errP) throw errP;

            proyectosGlobales = proyectos;
            renderizarEspacios(espacios);
            renderizarProyectos(proyectosGlobales);

        } catch (error) {
            console.error("Error en Dashboard:", error);
            document.getElementById('tabla-proyectos').innerHTML = '<tr><td colspan="5" style="color:red">Error al leer de Supabase.</td></tr>';
        }
    }

    function renderizarEspacios(espacios) {
        const container = document.getElementById('lista-espacios');
        let html = `
            <div class="tree-item active" onclick="filtrarPorEspacio('TODOS', this, 'Todos los Proyectos')">
                <i class="fas fa-layer-group"></i> MOSTRAR TODO
            </div>
        `;

        if (espacios && espacios.length > 0) {
            html += espacios.map(esp => `
                <div class="tree-item" onclick="filtrarPorEspacio('${esp.id}', this, '${esp.nombre}')">
                    <i class="fas fa-folder" style="color: #f59e0b;"></i> ${esp.nombre}
                </div>
            `).join('');
        }
        container.innerHTML = html;
    }

    function filtrarPorEspacio(idEspacio, elemento, nombreEspacio) {
        document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
        elemento.classList.add('active');

        document.getElementById('titulo-seccion').innerText = nombreEspacio;

        if (idEspacio === 'TODOS') {
            renderizarProyectos(proyectosGlobales);
        } else {
            const filtrados = proyectosGlobales.filter(p => p.espacio_id === idEspacio);
            renderizarProyectos(filtrados);
        }
    }

    function renderizarProyectos(proyectos) {
        const container = document.getElementById('tabla-proyectos');
        document.getElementById('stat-projects').innerText = proyectos.length;

        if (!proyectos || proyectos.length === 0) {
            container.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay proyectos registrados.</td></tr>';
            return;
        }

        container.innerHTML = proyectos.map(p => `
            <tr>
                <td><strong>${p.nombre}</strong></td>
                <td>${p.cliente || '---'}</td>
                <td>${p.ubicacion || '---'}</td>
                <td><span class="status-highlight">LISTO</span></td>
                <td>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" style="padding: 5px 8px; font-size: 0.7rem;" onclick="location.href='visor.html?id=${p.id}'">
                            <i class="fas fa-eye"></i> VER
                        </button>
                        <button class="btn btn-outline" style="padding: 5px 8px; font-size: 0.7rem; border-color: var(--accent); color: var(--accent);" onclick="location.href='editar.html?id=${p.id}'">
                            <i class="fas fa-edit"></i> EDITAR
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    window.onload = () => {
        cargarDashboard();
    };
</script>
</body>
</html>
